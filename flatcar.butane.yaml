variant: flatcar
version: 1.0.0

# 关闭控制台默认登陆
kernel_arguments:
  should_not_exist:
    - flatcar.autologin

# 设置 root 用户密码
passwd:
  users:
    - name: root
      # 默认密码为 tpclash, 可以使用以下命令重新生成密码 hash
      # openssl passwd -6 -salt SALT PASSWORD
      password_hash: $6$kovacs$.UwiKUJuLYO/.y7Qcxi/owx2H3dSy3GeX9j5NEyglpdWlGjSJZ0ITcN7NJk3yuXeU.MUYzw/sbZmG/tkVQD0j0
      # ssh-key 登陆配置
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMskC9phaoO1WJkQOvXcUxH+DlG8u/2u1ReMXOO9vkbW mritd@linux.com
storage:
  # 默认时区设置为上海
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/Asia/Shanghai
  files:
    # 自动更新策略:
    #   如果有系统更新则每天上午 10:30 进行重启更新, 更新窗口期不得超过 1h 
    #
    # Update policy
    - path: /etc/flatcar/update.conf
      mode: 0420
      contents:
        inline: |
          REBOOT_STRATEGY=reboot
          LOCKSMITHD_REBOOT_WINDOW_START=10:30
          LOCKSMITHD_REBOOT_WINDOW_LENGTH=1h          
    # Set hostname
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: tpclash
    # Rename nic
    - path: /etc/systemd/network/25-xnet.link
      mode: 0644
      contents:
        inline: |
          [Match]
          # Match the first interface found
          Path=pci-*
          
          [Link]
          # Use the traditional naming scheme
          Name=xnet
    # 设置静态 IP 地址
    # Set static ip
    - path: /etc/systemd/network/00-xnet.network
      contents:
        inline: |
          [Match]
          Name=xnet

          [Network]
          DHCP=no
          NTP=time.windows.com time.apple.com

          [Address]
          Address=192.168.1.111/24

          [Route]
          Destination=0.0.0.0/0
          Gateway=192.168.1.1
    # 设置上游 DNS, 并关闭 systemd-resolved 的 53 端口监听, 同时修复本地 DNS 不走 Clash 的问题
    # Fix clash `tun.auto-route`, ref: https://github.com/Dreamacro/clash/issues/2671
    - path: /etc/systemd/resolved.conf.d/25-xnet.conf
      contents:
        inline: |
          [Resolve]
          DNS=223.5.5.5
          DNS=119.29.29.29
          Domains=~.
          DNSStubListener=no
  directories:
    # Create clash storage dir
    - path: /opt/tpclash
      overwrite: true

systemd:
  units:
    # 请自行调整 tpclash 命令
    - name: tpclash.service
      enabled: true
      contents: |
        [Unit]
        Description=TPClash
        After=network-online.target
        Wants=network-online.target

        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker rm -f tpclash
        ExecStartPre=/usr/bin/docker pull mritd/tpclash
        ExecStart=/usr/bin/docker run --tty \
                                  --privileged \
                                  --network host \
                                  --name tpclash \
                                  --restart unless-stopped \
                                  -v /opt/tpclash:/data \
                                  -v /run:/run \
                                  mritd/tpclash \
                                    tpclash --config https://example.com/clash.yaml

        [Install]
        WantedBy=multi-user.target
